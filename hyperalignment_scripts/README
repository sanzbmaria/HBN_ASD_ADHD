# Functional Connectome Analysis Pipeline

This pipeline implements the methods from Busch et al. (2023) for analyzing coarse- and fine-scale functional connectomes using connectivity hyperalignment (CHA).

## Overview

The pipeline processes resting-state fMRI data through several stages:
1. Data parcellation
2. Anatomical alignment (AA) connectome building
3. Hyperalignment training and application
4. CHA connectome building
5. Analysis (reliability, heritability, prediction)

## Prerequisites

- Python 3 (for most scripts)
- Python 2 + PyMVPA (for hyperalignment only)
- Workbench Command (`wb_command`)
- CIFTI-format fMRI data
- Glasser parcellation atlas

## Setup

1. Configure paths and filename pattern in `utils_test.py`:
   ```python
   DTSERIES_ROOT = "path/to/dtseries"
   PTSERIES_ROOT = "hyperalignment_input/"
   PARCELLATION_FILE = "path/to/glasser/atlas.dlabel.nii"
   ```
   All dataset-specific naming and patterns are centralized in `utils_test.py` so you only need to edit one place.

## Pipeline Steps

### 1. Parcellation

Run the parcellation script to generate ptseries files from dtseries:
```bash
bash apply_parcellation.sh
```

### 2. Build AA Connectomes

```bash
python3 build_aa_connectomes.py
```
Creates fine-scale and coarse-scale connectomes using anatomical alignment.

### 3. Hyperalignment Training & Application

**Single parcel:**
```bash
python2 run_hyperalignment.py <parcel_number> [mode]
```

**All parcels (parallel):**
```bash
bash run_all_parcels_hyperalignment.sh [mode] [start_parcel] [end_parcel]
```

Modes: `full`, `split`, `both` (default: `both`)

### 4. Build CHA Connectomes

```bash
python3 build_CHA_connectomes.py
```

### 5. Create Similarity Matrices

```bash
python3 connectome_similarity_matrices.py <parcel_number> [mode]
```

### 6. Analysis

**Reliability analysis:**
```bash
python3 idm_reliability.py
```

**Compare AA vs CHA:**
```bash
python3 compare_aa_cha_connectomes.py
```

**Visualize results:**
```bash
python3 plot_similarity_results.py
```

## Configuration Details

All dataset-specific paths and filename patterns are configured in `utils_test.py`. Edit that file to point to your dtseries directory, parcellation atlas, and ptseries output location.

## Key Files

- `utils_test.py` - Configure paths and filename patterns here
- `apply_parcellation.sh` - Parcellation script
- `build_aa_connectomes.py` - Anatomical alignment connectomes
- `run_hyperalignment.py` - Hyperalignment (requires Python 2)
- `build_CHA_connectomes.py` - Hyperaligned connectomes
- `idm_reliability.py` - Split-half reliability analysis

## Output Structure

```
connectome_outputs/
├── fine/parcel_XXX/          # AA fine-scale connectomes
├── coarse/parcel_XXX/        # AA coarse-scale connectomes
├── hyperalignment_output/
│   ├── aligned_timeseries/   # Hyperaligned timeseries
│   ├── mappers/              # Transformation matrices
│   └── connectomes/          # CHA connectomes
├── similarity_matrices/      # Subject similarity matrices
└── reliability_results/      # Reliability analysis outputs
```

## Important Notes

- Hyperalignment requires Python 2 and PyMVPA
- Training uses a configurable subset of subjects by default (see hyperalignment script)
- Split-half analysis creates pseudo-sessions for reliability testing
- All other scripts use Python 3

## Troubleshooting

- If `idm_reliability.py` finds no split matrices, run `connectome_similarity_matrices.py` first
- If hyperalignment fails, check that `build_aa_connectomes.py` completed successfully
- If parcellation fails, verify `wb_command` is installed and the parcellation file exists
